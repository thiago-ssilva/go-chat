<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Zap</title>
        <link rel="stylesheet" href="https://unpkg.com/open-props">
        <link rel="stylesheet" href="https://unpkg.com/open-props/normalize.min.css">
        <link rel="stylesheet" href="https://unpkg.com/open-props/buttons.min.css">
        <link rel="stylesheet"  href="static/index.css">
    </head>
    <body>
        <!-- Login Dialog -->
        <dialog id="loginDialog" open>
            <form id="loginForm" name="login" class="form-stack">
                <div id="loginError" class="error-message" hidden></div>
                <div class="form-field">
                    <label for="username">Usu치rio</label>
                    <input type="text" id="username" name="username" required
                        placeholder="Digite seu nome de usu치rio">
                </div>
                <button type="submit" id="loginSubmit">
                    <span class="button-text">Entrar</span>
                    <span class="button-loading" hidden>Conectando...</span>
                </button>
            </form>
        </dialog>

        <!-- Chat Interface -->
        <div id="chatContainer" class="chat-container" hidden>
            <!-- Header -->
            <header class="chat-header">
                <h2>Chat Room</h2>
                <span id="currentUser" class="user-badge"></span>
            </header>

            <!-- Messages -->
            <main class="messages-container" id="messagesContainer">
                <!-- Empty state -->
                <div id="emptyState" class="empty-state">
                    <div class="empty-state-icon">游눫</div>
                    <p class="empty-state-text">Seja o primeiro a enviar uma mensagem!</p>
                </div>
            </main>

            <!-- Input Area -->
            <footer class="input-area">
                <form name="message" style="display: contents">
                    <input type="text" id="messageInput" name="message" required placeholder="Digite sua mensagem...">
                    <button id="sendBtn">Enviar</button>
                </form>
            </footer>
        </div>
        <script type="module">
        let conn = null
        let username = null

        const DOMElements = {
            _messagesContainer: null,
            getLoginDialog() { return document.getElementById("loginDialog") },
            getLoginForm() { return document.forms.login },
            getLoginError() { return document.getElementById("loginError") },
            getLoginSubmit() { return document.getElementById("loginSubmit") },
            getUsernameInput() { return document.getElementById("username") },
            getChatContainer() { return document.getElementById("chatContainer") },
            getUserBadge() { return  document.getElementById('currentUser') },
            getMessagesContainer() { return document.getElementById('messagesContainer') },
            getMessagesForm() { return document.forms.message },
            getEmptyState() { return document.getElementById('emptyState') },
            getMessagesInput() { return document.getElementById('messageInput') },
            createMessage(message) {
                const isOwn = username === message.username
                const msgContainer = this._messageContainer || this.getMessagesContainer()
                const messageDiv = document.createElement('div')
                messageDiv.className = `message ${isOwn ? 'own' : 'other'}`
                let content = ''
                if (!isOwn) {
                    content += `<div class="message-username">${message.username}</div>`
                }
                content += `<div>${message.content}</div>`

                messageDiv.innerHTML = content
                messagesContainer.appendChild(messageDiv)

                messagesContainer.scrollTop = messagesContainer.scrollHeight
            }
        }

        // Error handling functions
        function showError(message) {
            const errorEl = DOMElements.getLoginError()
            const formField = document.querySelector('.form-field')

            errorEl.textContent = message
            errorEl.hidden = false
            formField.classList.add('error')
        }

        function clearError() {
            const errorEl = DOMElements.getLoginError()
            const formField = document.querySelector('.form-field')

            errorEl.hidden = true
            formField.classList.remove('error')
        }

        function setLoading(loading) {
            const submitBtn = DOMElements.getLoginSubmit()
            const buttonText = submitBtn.querySelector('.button-text')
            const buttonLoading = submitBtn.querySelector('.button-loading')

            submitBtn.disabled = loading
            buttonText.hidden = loading
            buttonLoading.hidden = !loading
        }

        DOMElements.getUsernameInput().addEventListener('input', clearError)

        DOMElements.getLoginForm().addEventListener("submit", function(evt) {
            evt.preventDefault()
            clearError()

            const formData = new FormData(evt.target)
            username = formData.get('username').trim()

            // Basic validation
            if (!username) {
                showError('Nome de usu치rio 칠 obrigat칩rio')
                return
            }

            if (username.length < 2) {
                showError('Nome de usu치rio deve ter pelo menos 2 caracteres')
                return
            }

            if (username.length > 20) {
                showError('Nome de usu치rio deve ter no m치ximo 20 caracteres')
                return
            }

            initChat()
        })

        DOMElements.getMessagesForm().addEventListener("submit", function(evt) {
            evt.preventDefault()
            const formData = new FormData(event.target)
            const msg = formData.get('message')

            if (!conn || !msg) return;

            conn.send(msg)
            evt.target.reset()
        })

        function initChat() {
            if (!window['WebSocket']) {
                showError("O navegador n칚o suporta WebSocket!")
                return
            }

            setLoading(true)

            conn = new WebSocket(`ws://${document.location.host}/ws?username=${username}`)

            conn.onopen = function() {
                setLoading(false)
                DOMElements.getLoginDialog().close()

                const chatContainer = DOMElements.getChatContainer()
                const userBadge = DOMElements.getUserBadge()

                chatContainer.hidden = false
                userBadge.textContent = username
                DOMElements.getMessagesInput().focus()
            }

            conn.onerror = function(evt) {
                setLoading(false)
                showError("Erro ao conectar. Tente novamente.")
                DOMElements.getUsernameInput().focus()
                console.error('WebSocket error:', evt)
            }

            conn.onclose = function(evt) {
                setLoading(false)

                if (!DOMElements.getChatContainer().hidden) {
                    DOMElements.getChatContainer().hidden = true
                    DOMElements.getUserBadge().textContent = ''
                    DOMElements.getLoginDialog().open = true
                }
            }

            conn.onmessage = function(evt) {
                try {
                    const emptyState = DOMElements.getEmptyState()
                    emptyState.hidden = true
                    const data = JSON.parse(evt.data)
                    data.messages.forEach(msg => DOMElements.createMessage(msg))
                } catch (err) {
                    console.error('Unable to parse messages', err)
                }
            }
        }
        </script>
    </body>
</html>

<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Zap</title>
        <link rel="stylesheet" href="https://unpkg.com/open-props">
        <link rel="stylesheet" href="https://unpkg.com/open-props/normalize.min.css">
        <link rel="stylesheet" href="https://unpkg.com/open-props/buttons.min.css">
        <link rel="stylesheet"  href="static/index.css">
    </head>
    <body>
        <!-- Login Dialog -->
        <dialog id="loginDialog" open>
            <form id="loginForm" name="login" class="form-stack">
                <div id="loginError" class="error-message" hidden></div>
                <div class="form-field">
                    <label for="username">UsuÃ¡rio</label>
                    <input type="text" id="username" name="username" required
                        placeholder="Digite seu nome de usuÃ¡rio">
                </div>
                <button type="submit" id="loginSubmit">
                    <span class="button-text">Entrar</span>
                    <span class="button-loading" hidden>Conectando...</span>
                </button>
            </form>
        </dialog>

        <!-- Chat Interface -->
        <div id="chatContainer" class="chat-container" hidden>
            <!-- Header -->
            <header class="chat-header">
                <h2>Chat Room</h2>
                <span id="currentUser" class="user-badge"></span>
            </header>

            <!-- Messages -->
            <main class="messages-container" id="messagesContainer">
                <!-- Empty state -->
                <div id="emptyState" class="empty-state">
                    <div class="empty-state-icon">ðŸ’¬</div>
                    <p class="empty-state-text">Seja o primeiro a enviar uma mensagem!</p>
                </div>
            </main>

            <!-- Input Area -->
            <footer class="input-area">
                <form name="message" style="display: contents">
                    <input type="text" id="messageInput" name="message" required placeholder="Digite sua mensagem...">
                    <button id="sendBtn">Enviar</button>
                </form>
            </footer>
        </div>
        <script type="module">
        class DOMManager {
            getLoginDialog() { return document.getElementById("loginDialog") }
            getLoginForm() { return document.forms.login }
            getLoginError() { return document.getElementById("loginError") }
            getLoginSubmit() { return document.getElementById("loginSubmit") }
            getUsernameInput() { return document.getElementById("username") }
            getChatContainer() { return document.getElementById("chatContainer") }
            getUserBadge() { return document.getElementById('currentUser') }
            getMessagesContainer() { return document.getElementById('messagesContainer') }
            getMessagesForm() { return document.forms.message }
            getEmptyState() { return document.getElementById('emptyState') }
            getMessagesInput() { return document.getElementById('messageInput') }

            showError(message) {
                const errorEl = this.getLoginError()
                const formField = document.querySelector('.form-field')

                errorEl.textContent = message
                errorEl.hidden = false
                formField.classList.add('error')
            }

            clearError() {
                const errorEl = this.getLoginError()
                const formField = document.querySelector('.form-field')

                errorEl.hidden = true
                formField.classList.remove('error')
            }

            setLoading(loading) {
                const submitBtn = this.getLoginSubmit()
                const buttonText = submitBtn.querySelector('.button-text')
                const buttonLoading = submitBtn.querySelector('.button-loading')

                submitBtn.disabled = loading
                buttonText.hidden = loading
                buttonLoading.hidden = !loading
            }

            createMessage(message, username, isOwn) {
                const msgContainer = this.getMessagesContainer()
                const messageDiv = document.createElement('div')
                messageDiv.className = `message ${isOwn ? 'own' : 'other'}`

                let content = ''

                if (!isOwn) {
                    content += `<div class="message-username">${message.username}</div>`
                }
                content += `<div>${message.content}</div>`

                messageDiv.innerHTML = content
                msgContainer.appendChild(messageDiv)  // âœ… Fixed: msgContainer

                msgContainer.scrollTop = msgContainer.scrollHeight  // âœ… Fixed: msgContainer
            }
        }

        class ChatApp {
            constructor() {
                this.conn = null;
                this.username = null;
                this.dom = new DOMManager()
            }

            run() {
                this.dom.getLoginForm().addEventListener("submit", (evt) => this.handleLogin(evt))
                this.dom.getMessagesForm().addEventListener("submit", (evt) => this.handleMessage(evt))
                this.dom.getUsernameInput().addEventListener('input', () => this.dom.clearError())
            }

            async handleLogin(evt) {
                try {
                    evt.preventDefault()
                    this.dom.clearError()

                    const formData = new FormData(evt.target)
                    const newUsername = formData.get('username').trim()

                    if (!newUsername) {
                        return this.dom.showError('Nome de usuÃ¡rio Ã© obrigatÃ³rio')
                    }

                    const response = await fetch(`http://${document.location.host}/api/users/validate/username?username=${newUsername}`);
                    const data = await response.json();

                    if (response.ok && data.valid) {
                        return this.initWebSocket(newUsername);
                    }
                    if (data.code === 'USERNAME_TAKEN') {
                        return this.dom.showError('Nome do usuÃ¡rio jÃ¡ utilizado.')
                    }
                    if (data.code === 'USERNAME_LENGTH') {
                        return this.dom.showError('Nome deve ter entre 3 e 20 caracteres.')
                    }

                    return this.dom.showError('Erro de validaÃ§Ã£o. Tente novamente.')

                } catch (err) {
                    console.log(err)
                    return this.dom.showError('Erro de validaÃ§Ã£o. Tente novamente.')
                }
            }

            handleMessage(evt) {
                evt.preventDefault()
                const formData = new FormData(evt.target)
                const msg = formData.get('message')

                if (!this.conn || !msg) return

                this.conn.send(msg)
                evt.target.reset()
            }

            initWebSocket(username) {
                if (!window['WebSocket']) {
                    this.dom.showError('O navegador nÃ£o suporta WebSocket!')
                    return
                }

                this.dom.setLoading(true)

                this.conn = new WebSocket(`ws://${document.location.host}/ws?username=${username}`)
                this.username = username

                this.conn.onopen = () => this.handleWebSocketOpen()
                this.conn.onerror = (evt) => this.handleWebSocketError(evt)
                this.conn.onclose = (evt) => this.handleWebSocketClose(evt)
                this.conn.onmessage = (evt) => this.handleWebSocketMessage(evt)
            }

            handleWebSocketOpen() {
                this.dom.setLoading(false)
                this.dom.getLoginDialog().close()

                const chatContainer = this.dom.getChatContainer()
                const userBadge = this.dom.getUserBadge()

                chatContainer.hidden = false
                userBadge.textContent = this.username
                this.dom.getMessagesInput().focus()
            }

            handleWebSocketError(evt) {
                this.dom.setLoading(false)
                this.dom.showError("Erro ao conectar. Tente novamente.")
                this.dom.getUsernameInput().focus()
                console.error('WebSocket error:', evt)
            }

            handleWebSocketClose(evt) {
                this.dom.setLoading(false)
                const chatContainer = this.dom.getChatContainer()

                if (!chatContainer.hidden) {
                    chatContainer.hidden = true
                    this.dom.getUserBadge().textContent = ''
                    this.dom.getLoginDialog().open = true
                }
            }

            handleWebSocketMessage(evt) {
                try {
                    const emptyState = this.dom.getEmptyState()
                    emptyState.hidden = true
                    const data = JSON.parse(evt.data)
                    data.messages.forEach(msg => this.dom.createMessage(msg, this.username, this.username === msg.username))
                } catch (err) {
                    console.error('Unable to parse messages', err)
                }
            }
        }

        (new ChatApp()).run()
        </script>
    </body>
</html>
